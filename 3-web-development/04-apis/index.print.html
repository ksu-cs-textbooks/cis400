




	
	
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		
		

	
	
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		
		

	
	
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		

	
	
		
		
		

	
	
		
		

	
	
		

	
	
		
		
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.117.0">
    <meta name="generator" content="Relearn 5.18.0">
    <meta name="description" content="K-State CIS 400 Textbook">
    <meta name="author" content="Nathan Bean">
    <title>Web APIs :: K-State CIS 400 Textbook</title>
    <link href="https://ksu-cs-textbooks.github.io/cis400/3-web-development/04-apis/index.html" rel="canonical" type="text/html" title="Web APIs :: K-State CIS 400 Textbook">
    <link href="https://ksu-cs-textbooks.github.io/cis400/3-web-development/04-apis/index.xml" rel="alternate" type="application/rss+xml" title="Web APIs :: K-State CIS 400 Textbook">
    <link href="https://ksu-cs-textbooks.github.io/cis400/3-web-development/04-apis/tele.html" rel="alternate" type="text/html" title="Web APIs :: K-State CIS 400 Textbook">
    <link href="https://ksu-cs-textbooks.github.io/cis400/3-web-development/04-apis/embed.html" rel="alternate" type="text/html" title="Web APIs :: K-State CIS 400 Textbook">
    <!-- https://github.com/filamentgroup/loadCSS/blob/master/README.md#how-to-use -->
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/fontawesome-all.min.css?1692653059" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://ksu-cs-textbooks.github.io/cis400/css/fontawesome-all.min.css?1692653059" rel="stylesheet"></noscript>
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/nucleus.css?1692653059" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/auto-complete.css?1692653059" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://ksu-cs-textbooks.github.io/cis400/css/auto-complete.css?1692653059" rel="stylesheet"></noscript>
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/perfect-scrollbar.min.css?1692653059" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/fonts.css?1692653059" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="https://ksu-cs-textbooks.github.io/cis400/css/fonts.css?1692653059" rel="stylesheet"></noscript>
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/theme.css?1692653059" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/theme-auto.css?1692653059" rel="stylesheet" id="variant-style">
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/variant.css?1692653059" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/print.css?1692653059" rel="stylesheet" media="print">
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/format-print.css?1692653059" rel="stylesheet">
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/ie.css?1692653059" rel="stylesheet">
    <script src="https://ksu-cs-textbooks.github.io/cis400/js/url.js?1692653059"></script>
    <script src="https://ksu-cs-textbooks.github.io/cis400/js/variant.js?1692653059"></script>
    <script>
      // hack to let hugo tell us how to get to the root when using relativeURLs, it needs to be called *url= for it to do its magic:
      // https://github.com/gohugoio/hugo/blob/145b3fcce35fbac25c7033c91c1b7ae6d1179da8/transform/urlreplacers/absurlreplacer.go#L72
      window.index_js_url="https://ksu-cs-textbooks.github.io/cis400/index.search.js";
      var root_url="https://ksu-cs-textbooks.github.io/cis400/";
      var baseUri=root_url.replace(/\/$/, '');
      // translations
      window.T_Copy_to_clipboard = 'Copy to clipboard';
      window.T_Copied_to_clipboard = 'Copied to clipboard!';
      window.T_Copy_link_to_clipboard = 'Copy link to clipboard';
      window.T_Link_copied_to_clipboard = 'Copied link to clipboard!';
      window.T_No_results_found = 'No results found for \u0022{0}\u0022';
      window.T_N_results_found = '{1} results found for \u0022{0}\u0022';
      // some further base stuff
      var baseUriFull='https:\/\/ksu-cs-textbooks.github.io\/cis400/';
      window.variants && variants.init( [ 'auto', 'light-theme', 'dark-theme' ] );
    </script>
    
    <link href="https://ksu-cs-textbooks.github.io/cis400/css/custom.css?1692653059" rel="stylesheet">

  </head>
  <body class="mobile-support print disableInlineCopyToClipboard" data-url="https://ksu-cs-textbooks.github.io/cis400/3-web-development/04-apis/index.html">
    <div id="body" class="default-animation">
      <div id="sidebar-overlay"></div>
      <div id="toc-overlay"></div>
      <nav id="topbar" class="highlightable">
        <div>
          <div id="top-tele-link">
            <a class="print-link" title='Teleprompter View' href="https://ksu-cs-textbooks.github.io/cis400/3-web-development/04-apis/tele.html">
              <i class="fas fa-tv fa-fw"></i>
            </a>
          </div>
          <div id="top-embed-link">
            <a class="print-link" title='Embeddable Version' href="https://ksu-cs-textbooks.github.io/cis400/3-web-development/04-apis/embed.html">
              <i class="fas fa-expand-arrows-alt fa-fw"></i>
            </a>
          </div>
          <div id="breadcrumbs">
            <span id="sidebar-toggle-span">
              <a href="#" id="sidebar-toggle" class="topbar-link" title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a>
            </span>
            <ol class="links" itemscope itemtype="http://schema.org/BreadcrumbList">
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="https://ksu-cs-textbooks.github.io/cis400/index.html"><span itemprop="name">CIS 400: Object-Oriented Design, Implementation, and Testing</span></a><meta itemprop="position" content="1"> &gt; </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="https://ksu-cs-textbooks.github.io/cis400/3-web-development/index.html"><span itemprop="name">Web Development</span></a><meta itemprop="position" content="2"> &gt; </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Web APIs</span><meta itemprop="position" content="3"></li>
            </ol>
          </div>
        </div>
      </nav>
      <main id="body-inner" class="highlightable chapter narrow" tabindex="-1">
        <div class="flex-block-wrapper">
          <article class="chapter">
            <header class="headline">
            </header>


<div class="article-subheading">Chapter 4</div>
<h1 id="web-apis">Web APIs</h1>

<p>Making the Web Accessible - for Programs</p>

            <footer class="footline">

            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsections of Web APIs</h1>
    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="introduction">Introduction</h1>

<p>Not all web applications are built to be viewed in a browser.  Many are built to be used by other programs.  We call these web applications Web APIs (Application Programming Interfaces).  These also make HTTP or HTTPS requests against our apps, but usually instead of serving HTML, we serve some form of serialized data instead - most commonly XML or JSON.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="making-requests">Making Requests</h1>

<p>Making a HTTP request is a multi-step process.  First you must establish a connection with the server, then create the request data, then you must stream that data to your server through the connection.  Once the server has received and processed your request data, it should stream a response back to you.</p>
<p>You can write code to handle each step, but most programming languages provide one or more libraries that provide a level of abstraction to this process. The C# language actually offers several options in its system libraries, and there are multiple open-source options as well.</p>
<h3 id="webrequest">WebRequest</h3>
<p>The simplest of these is the <code>WebRequest</code> object.  It represents and carries out a single HTTP request and provides the response.  Let&rsquo;s take a look at an example, which retrieves a &ldquo;Joke of the Day&rdquo; from a web API at <a href="https://jokes.one" target="_blank">https://jokes.one</a>
:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>WebRequest request = WebRequest.Create(<span style="color:#e6db74">&#34;http://api.jokes.one/jod&#34;</span>);</span></span></code></pre></div><p>This one line of code creates the <code>WebRequest</code> object.  Notice that we are <strong>not using a constructor</strong>.  Instead, we invoke a <code>Create()</code> method.  This is an example of the <a href="https://en.wikipedia.org/wiki/Factory_method_pattern" target="_blank">Factory Method Pattern</a>
, which you will learn more about in CIS 501.  But to briefly introduce the concept, the <code>WebRequest</code> class is actually a <em>base class</em> for a multiple different classes, each representing a <em>specific kind</em> of web request (i.e. using HTTP, HTTPS, FTP and so on).  Based on the URI supplied to <code>WebRequest.Create(Uri uri)</code>, the method will determine the appropriate kind of request to make, and create and return the corresponding object.</p>
<p>Now that we have our request, we can send it and obtain a response with:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>WebResponse response = request.GetResponse();</span></span></code></pre></div><p>This opens the connection to the server, streams the request to it, and then captures the sever&rsquo;s response.  We can access this response as a stream (similar to how we would read a file):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Stream responseStream = response.GetStream() 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  StreamReader reader = <span style="color:#66d9ef">new</span> StreamReader(responseStream);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">string</span> responseText= reader.ReadToEnd();
</span></span><span style="display:flex;"><span>  Console.WriteLine(responseText);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>You likely are wondering what the <code>using</code> and curly braces <code>{}</code> are doing in this code.  They are there because the <code>Stream</code> object implements the <code>IDisposable</code> interface.  We&rsquo;ll discuss this in detail in the next section.  But for now, let&rsquo;s focus on how we use the stream.  First we create a <code>StreamReader</code> to read it:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>  StreamReader reader = <span style="color:#66d9ef">new</span> StreamReader(responseStream);</span></span></code></pre></div><p>Then read to the end of the stream:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">string</span> responseFromServer = reader.ReadToEnd();</span></span></code></pre></div><p>And write the response&rsquo;s text to the console:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>  Console.WriteLine(responseText);</span></span></code></pre></div><p>Finally, we must close the <code>WebResponse</code> object&rsquo;s connection to the server once we are done:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>  response.Close();</span></span></code></pre></div><p>This last step is important, as the open connection is actually managed by our operating system, and unless we close it, our system resources will be tied up, making our computer slower and potentially unable to make web requests for other programs (including your browser)!</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="working-with-disposables">Working With Disposables</h1>

<p>In the previous section, we looked at a line of code that included the keyword <code>using</code> in a way you haven&rsquo;t probably seen it before:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Stream responseStream = response.GetStream() 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// TODO: Use the responseStream</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Let&rsquo;s examine this statement in more detail.  This use of <code>using</code> is a <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/using-statement" target="_blank">using statement</a>
, not to be confused with a <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/using-directive" target="_blank">using directive</a>
.</p>
<p>When you put a statement like <code>using System.Text</code>, you are using the <em>using directive</em>, which instructs the compiler to use types in the corresponding namespace without needing to provide the fully qualified namespace. You&rsquo;ve been using this technique for some time, so it should be familiar to you.</p>
<p>In contrast, the <em>using statement</em> is used in the body of your code in conjunction with an object implementing the <code>IDisposable</code> interface.  Objects that implement this interface have a <code>Dispose()</code> method, which needs to be called when you are done with them.  These kinds of objects typically access some resource from outside of the program, which needs to be released when you are done with it.</p>
<h4 id="managed-vs-unmanaged-resources">Managed vs. Unmanaged Resources</h4>
<p>To understand this better, let&rsquo;s talk about <em>managed</em> vs. <em>unmanaged</em> resources.  We say a resource is <em>managed</em> when obtaining and releasing it is handled by the language.  Memory is a great example of this.  In C#, we are using <em>managed memory</em>.  When we invoke a constructor or declare an array, the interpreter automatically creates the memory we need to hold them.</p>
<p>In contrast, C uses <em>unmanaged memory</em>.  When we want to create an array, we must <em>allocate</em> that memory with <code>alloc()</code>, <code>calloc()</code>, or <code>malloc()</code> function call.</p>
<p>This might not seem very different, until we are done with the array.  In C#, we can simply let it fall out of scope, knowing the garbage collector should eventually free that memory.  But in a C program, we must manually free the memory with a call to <code>free()</code>.</p>
<p>Sometimes in C#, we need to access some resource in a way that is unmanaged - in which case, we must be sure to free the resource when we are done with it.</p>
<h4 id="idisposable">IDisposable</h4>
<p>The <code>IDisposable()</code> interface provides a standard way of handling this kind of situation. It requires any class implementing it to define a <code>Dispose()</code> method that frees any unmanaged resources.  A <em>stream</em> (the data being read in from a file, the network, or a terminal) is a good example of an unmanaged resource - the stream is actually created by the operating system, and the <code>Stream</code> object (a <code>FileStream</code>, <code>BufferedStream</code>, etc) is a C# object providing access to it.</p>
<p>Let&rsquo;s focus on a <code>FileStream</code> for a moment.  One is created every time you ask the operating system to open a file, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>FileStream fs = File.OpenRead(<span style="color:#e6db74">&#34;somefile.txt&#34;</span>);</span></span></code></pre></div><p>The <code>File.OpenRead()</code> method asks the operating system to provide a stream to the file named <code>&quot;somefile.txt&quot;</code>.  We can then read that stream until we reach the end of file marker (indicating we&rsquo;ve read the entire file):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">byte</span> data = fs.ReadByte();
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Invariant: while there are bytes in the file to read</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span>(data != -<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Write the current byte to the console</span>
</span></span><span style="display:flex;"><span>  System.Out.Write(data);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Read the next byte</span>
</span></span><span style="display:flex;"><span>  data = fs.ReadByte();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Once we&rsquo;ve finished reading the file, we need to call <code>Dispose()</code> on the stream to tell the operating system that we&rsquo;re done with it:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>fs.Dispose();</span></span></code></pre></div><p>If we don&rsquo;t, then the operating system will assume we&rsquo;re still working with the file, and refuse to let any other program read it.  Including our own program, if we were to run it again.</p>
<p>But what happens if an error occurs while reading the file? We&rsquo;ll never reach the call to <code>Dispose()</code>, so we&rsquo;ll <em>never free the file</em>!  In order to access it, we&rsquo;d have to restart the computer.  Not great.</p>
<p>We <em>could</em> manage this with a <code>try/catch/finally</code>, i.e.:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  FileStream fs = File.OpenRead(<span style="color:#e6db74">&#34;somefile.txt&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">byte</span> data = fs.ReadByte();
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Invariant: while there are bytes in the file to read</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>(data != -<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Write the current byte to the console</span>
</span></span><span style="display:flex;"><span>    System.Out.Write(data);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Read the next byte</span>
</span></span><span style="display:flex;"><span>    data = fs.ReadByte();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  fs.Dispose();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">catch</span>(Exception e) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Do something with e</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">finally</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  fs.Dispose();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>But you have to catch all exceptions.</p>
<h4 id="using-statement">Using Statement</h4>
<p>A using statement operates similarly, but takes far less typing:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> FileStream fs = File.OpenRead(<span style="color:#e6db74">&#34;somefile.txt&#34;</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">byte</span> data = fs.ReadByte();
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Invariant: while there are bytes in the file to read</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>(data != -<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Write the current byte to the console</span>
</span></span><span style="display:flex;"><span>    System.Out.Write(data);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Read the next byte</span>
</span></span><span style="display:flex;"><span>    data = fs.ReadByte();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>It also comes with some benefits.  One, it creates a new scope (within the <code>{}</code> following the using statement).  If for some reason the stream can&rsquo;t be opened, this scope is skipped over.  Similarly it jumps execution to the end of the scope if an error occurs.  Finally, it <em>automatically</em> calls <code>Dispose()</code> when the scope ends.</p>
<h4 id="syntax-shorthand">Syntax Shorthand</h4>
<p>As of C# 8.0, a shorthand for the using statement that omits the scope markers (the <code>{}</code>) is available.  In this case, the scope is from the start of the <code>using</code> statement to the end of its containing scope (usually a method):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> FileStream fs = File.OpenRead(<span style="color:#e6db74">&#34;somefile.txt&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">byte</span> data = fs.ReadByte();
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Invariant: while there are bytes in the file to read</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span>(data != -<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Write the current byte to the console</span>
</span></span><span style="display:flex;"><span>  System.Out.Write(data);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Read the next byte</span>
</span></span><span style="display:flex;"><span>  data = fs.ReadByte();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>This format can be nice when you need to nest multiple <code>using</code> statements, but I would suggest sticking with the scoped version until you are comfortable with the concepts involved.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="parsing-api-data">Parsing API Data</h1>

<p>Web APIs typically provide their data in a structured format, i.e. XML or JSON.  To use this within a C# program you&rsquo;ll need to either parse it or convert it into an object or objects.</p>
<p>The Joke of the Day API can provide either - we just need to specify our preference with a <code>Accept</code> header in our HTTP request. This header lets the server know what format(s) of data we are ready to process.  XML is signified by the MIME type <code>application/xml</code> and JSON by <code>application/json</code>.</p>
<p>To set this (or any other header) in our <code>WebRequest</code> object, we use the <code>Header</code> property&rsquo;s <code>Add()</code> method:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>WebRequest request = WebRequest.Create(<span style="color:#e6db74">&#34;http://api.jokes.one/jod&#34;</span>);
</span></span><span style="display:flex;"><span>request.Headers.Add(<span style="color:#e6db74">&#34;Accept&#34;</span>, <span style="color:#e6db74">&#34;application/json&#34;</span>);</span></span></code></pre></div><p>For JSON, or:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>WebRequest request = WebRequest.Create(<span style="color:#e6db74">&#34;http://api.jokes.one/jod&#34;</span>);
</span></span><span style="display:flex;"><span>request.Headers.Add(<span style="color:#e6db74">&#34;Accept&#34;</span>, <span style="color:#e6db74">&#34;application/xml&#34;</span>);</span></span></code></pre></div><p>For XML.</p>
<h4 id="parsing-xml">Parsing XML</h4>
<p>Let&rsquo;s start by examining the older format, XML.  Assuming you have set the <code>Accept</code> header as discussed above, you will receive a response similar to (but with a different joke):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;response&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;success&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;total&gt;</span>1<span style="color:#f92672">&lt;/total&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/success&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;contents&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;jokes&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;description&gt;</span>Joke of the day <span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;language&gt;</span>en<span style="color:#f92672">&lt;/language&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;background/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;category&gt;</span>jod<span style="color:#f92672">&lt;/category&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;date&gt;</span>2021-11-29<span style="color:#f92672">&lt;/date&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;joke&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;title&gt;</span>Signs for every job<span style="color:#f92672">&lt;/title&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;lang&gt;</span>en<span style="color:#f92672">&lt;/lang&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;length&gt;</span>1749<span style="color:#f92672">&lt;/length&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;clean&gt;</span>0<span style="color:#f92672">&lt;/clean&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;racial&gt;</span>0<span style="color:#f92672">&lt;/racial&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;date&gt;</span>2021-11-29<span style="color:#f92672">&lt;/date&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;id&gt;</span>HqJ1i9L1ujVCcZmS5C4nhAeF<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;text&gt;</span>
</span></span><span style="display:flex;"><span>        In the front yard of a funeral home, &#34;Drive carefully, we&#39;ll wait.&#34; On an electrician&#39;s truck, &#34;Let us remove your shorts.&#34; Outside a radiator repair shop, &#34;Best place in town to take a leak.&#34; In a non-smoking area, &#34;If we see you smoking, we will assume you are on fire and take appropriate action.&#34; On a maternity room door, &#34;Push, Push, Push.&#34; On a front door, &#34;Everyone on the premises is a vegetarian except the dog.&#34; At an optometrist&#39;s office, &#34;If you don&#39;t see what you&#39;re looking for, you&#39;ve come to the right place.&#34; On a taxidermist&#39;s window, &#34;We really know our stuff.&#34; On a butcher&#39;s window, &#34;Let me meat your needs.&#34; On a butcher&#39;s window, &#34;You can beat our prices, but you can&#39;t beat our meat.&#34; On a fence, &#34;Salesmen welcome. Dog food is expensive.&#34; At a car dealership, &#34;The best way to get back on your feet - miss a car payment.&#34; Outside a muffler shop, &#34;No appointment necessary. We&#39;ll hear you coming.&#34; In a dry cleaner&#39;s emporium, &#34;Drop your pants here.&#34; On a desk in a reception room, &#34;We shoot every 3rd salesman, and the 2nd one just left.&#34; In a veterinarian&#39;s waiting room, &#34;Be back in 5 minutes. Sit! Stay!&#34; At the electric company, &#34;We would be delighted if you send in your bill. However, if you don&#39;t, you will be.&#34; In a Beauty Shop, &#34;Dye now!&#34; In a Beauty Shop, &#34;We curl up and Dye for you.&#34; On the side of a garbage truck, &#34;We&#39;ve got what it takes to take what you&#39;ve got.&#34; (Burglars please copy.) In a restaurant window, &#34;Don&#39;t stand there and be hungry, come in and get fed up.&#34; Inside a bowling alley, &#34;Please be quiet. We need to hear a pin drop.&#34; In a cafeteria, &#34;Shoes are required to eat in the cafeteria. Socks can eat any place they want.&#34;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/text&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/joke&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/jokes&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;copyright&gt;</span>2019-20 https://jokes.one<span style="color:#f92672">&lt;/copyright&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/contents&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/response&gt;</span></span></span></code></pre></div><p>We can parse this response with C#&rsquo;s <a href="https://docs.microsoft.com/en-us/dotnet/api/system.xml.xmldocument?view=net-6.0" target="_blank">XmlDocument Class</a>
 from the <code>System.Xml</code> namespace.  First, we create an instance of the class, using our response text.  We can use one of the <code>XmlDocument.Load()</code> overrides, which takes a stream, to process our response stream directly:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Stream responseStream = response.GetStream() 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  XmlDocument xDoc = <span style="color:#66d9ef">new</span> XmlDocument();
</span></span><span style="display:flex;"><span>  xDoc.Load(responseStream);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// TODO: get our joke!</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Then we can query the <code>XmlDocument</code> for the tag we care about, i.e. <em>response &gt; contents &gt; jokes &gt; joke &gt; text</em> (the text of the joke).  We use XPath syntax for this:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> node = xDoc.SelectSingleNode(<span style="color:#e6db74">&#34;/response/contents/jokes/joke/text&#34;</span>);</span></span></code></pre></div><p><a href="https://en.wikipedia.org/wiki/XPath" target="_blank">XPath</a>
 is a query language, much like CSS selectors, which allow you to navigate a XML document in a lot of different ways.  In this case, we are just finding the exact element based on its path.  Then we can pull its value, and do something with it (such as logging it to the console):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>  Console.WriteLine(node.InnerText);</span></span></code></pre></div><h4 id="parsing-json">Parsing JSON</h4>
<p>JavaScript Object Notation (JSON) has become a popular format for web APIs, as it usually requires less characters than the corresponding XML, and is natively serializable from JavaScript making it extremely compatible with client-side web applications.</p>
<p>Assuming you have set the <code>Accept</code> header as discussed above, you will receive a response similar to (but with a different joke):</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;success&#34;</span>:{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;total&#34;</span>:<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;contents&#34;</span>:{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;jokes&#34;</span>:[
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;description&#34;</span>:<span style="color:#e6db74">&#34;Joke of the day &#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;language&#34;</span>:<span style="color:#e6db74">&#34;en&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;background&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;category&#34;</span>:<span style="color:#e6db74">&#34;jod&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;date&#34;</span>:<span style="color:#e6db74">&#34;2021-11-30&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;joke&#34;</span>:{
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;title&#34;</span>:<span style="color:#e6db74">&#34;Class With Claus&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;lang&#34;</span>:<span style="color:#e6db74">&#34;en&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;length&#34;</span>:<span style="color:#e6db74">&#34;78&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;clean&#34;</span>:<span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;racial&#34;</span>:<span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;date&#34;</span>:<span style="color:#e6db74">&#34;2021-11-30&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;id&#34;</span>:<span style="color:#e6db74">&#34;LuVeRJsEIzCzvTnRmBTHXweF&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;text&#34;</span>:<span style="color:#e6db74">&#34;Q: What do you say to Santa when he&#39;s taking attendance at school?\nA: Present.&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;copyright&#34;</span>:<span style="color:#e6db74">&#34;2019-20 https:\/\/jokes.one&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>The C# system libraries provide JSON support in the <code>System.Text.Json</code> namespace using the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.text.json.jsonserializer?view=net-6.0" target="_blank">JsonSerializer</a>
 class. The default behavior of the deserializer is to deserialize into a <code>JsonDocument</code> composed of nested <code>JsonElement</code> objects - essentially, dictionaries of dictionaries.  As with the <code>XDocument</code>, we can deserialize JSON directly from a <code>Stream</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Stream responseStream = response.GetStream() 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  JsonDocument jDoc = JsonSerializer.Deserialize(responseStream);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// TODO: get our joke!</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>Then we can navigate from the root element (a <code>JsonElement</code> instance) down the nested path of key/value pairs, by calling <code>GetProperty()</code> to access each successive property, and then print the joke text to the console:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> contents = jDoc.RootElement.GetProperty(<span style="color:#e6db74">&#34;contents&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> jokes = contents.GetProperty(<span style="color:#e6db74">&#34;jokes&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> jokeData = jokes[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> joke = jokeData.GetProperty(<span style="color:#e6db74">&#34;joke&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> text = joke.GetProperty(<span style="color:#e6db74">&#34;text&#34;</span>);
</span></span><span style="display:flex;"><span>  Console.WriteLine(text);</span></span></code></pre></div><!-- 
This approach can be cumbersome, but there is another possibility - to deserialize the JSON directly into a C# object.  Let's look at that next.


#### Deserializing JSON into a C# Object

The `JsonSerializer` also allows us to deserialize JSON directly into a corresponding C# object.  For this to work, we have to define the structure of this object to match our expected response.  Since our JSON is a nested structure, we'll actually need _multiple_ classes to represent it.  Let's start with the innermost one - the joke itself, which has a structure like:

```json
{
  "title":"Class With Claus",
  "lang":"en",
  "length":"78",
  "clean":null,
  "racial":null,
  "date":"2021-11-30",
  "id":"LuVeRJsEIzCzvTnRmBTHXweF",
  "text":"Q: What do you say to Santa when he's taking attendance at school?\nA: Present."
}
```

We need to reproduce this as a C# class, converting the JSON properties into C# equivalents i.e.:

```csharp
public class Joke
{
  [JsonPropertyName("title")]
  public string Title {get; set;}

  [JsonPropertyName("lang")]
  public string Lang {get; set;}

  [JsonPropertyName("length")]
  public int Length {get; set;}

  [JsonPropertyName("clean")]
  public bool? Clean {get; set;}

  [JsonPropertyName("racial")]
  public bool? Racial {get; set;}

  [JsonPropertyName("date")]
  public DateTime Date {get; set;}

  [JsonPropertyName("id")]
  public string Id {get; set;}

  [JsonPropertyName("text")]
  public string Text {get; set;}
}
```

Note that for JSON, the standard naming convention is to use Camel Case property names, not the Pascal Case we use in C#.  The `[JsonPropertyName()]` attribute from the `System.Text.Json.Serialization` namespace allows us to indicate how the name needs to be transformed when we transform to and from a JSON string to match both naming conventions.

The `Joke` is then nested in a second object that provides additional metadata describing the joke:

```json
{
  "description":"Joke of the day ",
  "language":"en",
  "background":"",
  "category":"jod",
  "date":"2021-11-30",
  "joke":{...}
}
```

All we really care about here is the joke itself.  But the `JsonSerializer` will throw an error unless all properties are accounted for.  However, it does allow a bit of a wildcard in the form of a `Dictionary<string, JsonElement>` property - if we provide one named `ExtensionData`, then any property not otherwise present in the object will be mapped to it.  Let's take advantage of this to simplify our next class:

-->
            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="asynchronous-requests">Asynchronous Requests</h1>

<p>Now that we&rsquo;re more comfortable with <code>using</code> statements, let&rsquo;s return to our request-making code:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>WebRequest request = WebRequest.Create(<span style="color:#e6db74">&#34;http://api.jokes.one/jod&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Stream responseStream = response.GetStream() 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  StreamReader reader = <span style="color:#66d9ef">new</span> StreamReader(responseStream);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">string</span> responseText= reader.ReadToEnd();
</span></span><span style="display:flex;"><span>  Console.WriteLine(responseText);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>response.Close();</span></span></code></pre></div><p>The <code>response.GetStream()</code> triggers the http request, which hits the API and returns its result.  Remember a HTTP request is streamed across the internet, then processed by the server, and the response streamed back.  That can take some time (at least to a computer).  While the program waits on it to finish, it cannot do anything else.  For some programs, like one that only displays jokes, this is fine. But what if our program needs to also be responding to the user&rsquo;s events - like typing or moving the mouse? While the program is waiting, it is effectively paused, and nothing the user does will cause the program to change.</p>
<h4 id="asynchronous-methods">Asynchronous Methods</h4>
<p>This is where asynchronous methods come in. An asynchronous method operates on a separate thread, allowing execution of the program to continue.</p>
<p>let&rsquo;s revisit our <code>WebRequest</code> example:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>WebRequest request = WebRequest.Create(<span style="color:#e6db74">&#34;http://api.jokes.one/jod&#34;</span>);</span></span></code></pre></div><p>We can then make the request <em>asynchronously</em> by calling the asynchronous version of <code>GetResponse()</code> - <code>GetResponseAsync()</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>WebResponse response = <span style="color:#66d9ef">await</span> request.GetResponseAsync();</span></span></code></pre></div><p>The <code>await</code> keyword effectively pauses this thread of execution until the response is received.  Effectively, the subsequent code is set aside to be processed when the asynchronous method finishes or encounters an error.  This allows the main thread of the program to continue responding to user input and other events.  The rest of the process is handled exactly as before:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Stream responseStream = response.GetStream() 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  StreamReader reader = <span style="color:#66d9ef">new</span> StreamReader(responseStream);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">string</span> responseText= reader.ReadToEnd();
</span></span><span style="display:flex;"><span>  Console.WriteLine(responseText);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h4 id="writing-asynchronous-methods">Writing Asynchronous Methods</h4>
<p>Normally we would wrap the asynchronous method calls within our own asynchronous method.  Thus, we might define a method, <code>GetJoke()</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">async</span> GetJoke()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  WebRequest request = WebRequest.Create(<span style="color:#e6db74">&#34;http://api.jokes.one/jod&#34;</span>);
</span></span><span style="display:flex;"><span>  WebResponse response = <span style="color:#66d9ef">await</span> request.GetResponseAsync();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">using</span> Stream responseStream = response.GetStream() 
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    XmlDocument xDoc = <span style="color:#66d9ef">new</span> XmlDocument();
</span></span><span style="display:flex;"><span>    xDoc.Load(responseStream);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> node = xDoc.SelectSingleNode(<span style="color:#e6db74">&#34;/response/contents/jokes/joke/text&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> node.InnerText;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h4 id="asynchronous-asp-requestresponse-methods">Asynchronous ASP Request/Response Methods</h4>
<p>ASP.Net includes built-in support for asynchronous request handling.  You just need to add the <code>async</code> keyword to your <code>OnGet()</code> or <code>OnPost()</code> method, and the ASP.NET server will process it asynchronously.</p>
<p>For example, we could invoke our <code>GetJoke()</code> method in a <code>OnGet()</code>:</p>
<div class="wrap-code highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JokeModel</span> : PageModel 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> IActionResult OnGet()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> joke = <span style="color:#66d9ef">await</span> GetJoke();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Content(joke);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>This will cause the text of the joke to be sent as the response, and allow other pages to be served while this one request is awaiting a response from the Joke API.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="restful-routes">RESTful Routes</h1>

<p>Many web applications deal with some kind of <em>resource</em>, i.e. people, widgets, records.  Much like in object-orientation we have organized the program around objects, many web applications are organized around resources.  And as we have specialized ways to construct, access, and destroy objects, web applications need to create, read, update, and destroy resource records (we call these CRUD operations).</p>
<p>In his 2000 PhD. dissertation, Roy Fielding defined <a href="https://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank">Representational State Transfer (REST</a>
), a way of mapping HTTP routes to the CRUD operations for a specific resource.  This practice came to be known as RESTful routing, and has become one common strategy for structuring a web application&rsquo;s routes.  Consider the case where we have an online directory of students.  The students would be our resource, and we would define routes to create, read, update and destroy them by a combination of HTTP action and route:</p>
<table>
  <tr>
    <th>CRUD Operation</th>
    <th>HTTP Action</th>
    <th>Route</th>
  </tr>
  <tr>
    <td>Create</td>
    <td>POST</td>
    <td>/students</td>
  </tr>
  <tr>
    <td>Read (all)</td>
    <td>GET</td>
    <td>/students</td>
  </tr>
  <tr>
    <td>Read (one)</td>
    <td>GET</td>
    <td>/students/[ID]</td>
  </tr>
  <tr>
    <td>Update</td>
    <td>PUT or POST</td>
    <td>/students/[ID]</td>
  </tr>  
  <tr>
    <td>Destroy</td>
    <td>DELETE</td>
    <td>/students/[ID]</td>
  </tr>
</table>
<p>Here the <code>[ID]</code> is a unique identifier for the individual student.  Note too that we have <em>two</em> routes for reading - one for getting a list of <em>all</em> students, and one for getting the details of an individual student.</p>
<p>REST is a remarkably straightforward implementation of very common functionality, no doubt driving its wide adoption.  Razor pages supports REST implicitly - the RESTful resource <em>is the PageModel object</em>.  This is the reason model binding does not bind properties on GET requests by default - because a GET request is used to retrieve, not update a resource.  However, properties derived from the route (such as <code>:ID</code> in our example, <em>will</em> be bound and available on GET requests).</p>
<p>With Razor Pages, you can specify a route parameter after the <code>@page</code> directive.  I.e. to add our <code>ID</code> parameter, we would use:</p>
<div class="wrap-code highlight"><pre tabindex="0"><code class="language-cshtml" data-lang="cshtml">@page &#34;{ID?}&#34;</code></pre></div><p>We can use any parameter name; it doesn&rsquo;t have to be <code>ID</code> (though this is common).  The <code>?</code> indicates that the ID parameter is optional - so we can still visit <code>/students</code>.  Without it, we only can visit specific students, i.e. <code>/students/2</code>.</p>
<p>Route parameters can be bound using any of the binding methods we discussed previously - parameter binding, model binding, or be accessed directly from the <code>@RouteData.Values</code> dictionary.  When we <em>are</em> using these parameters to create or update new resources, we often want to take an additional step - <em>validating</em> the supplied data.</p>

            <footer class="footline">

            </footer>
          </article>

    
    
          <article class="default">
            <header class="headline">
            </header>
<h1 id="summary">Summary</h1>

<p>In this chapter we explored using web APIs to retrieve data from remote servers. We saw how to use the <code>WebRequest</code> object to make this task approachable.  We also revisited ideas you&rsquo;ve seen in prior courses like the <code>IDisposable</code> interface and <code>using</code> statements to work with unmanaged objects.  We saw how to consume XML data we receive as a response from a web API.</p>
<p>We also discussed using <code>async</code> methods to allow our programs to continue to respond to user input and incoming web requests while processing long-running tasks in parallel.  Finally, we discussed RESTful routes, a standardized way of determining the routes for your web API.</p>

            <footer class="footline">

            </footer>
          </article>

          </section>

        </div>
      </main>
    
<div class="git-footer">
<p class="theme-version-footer">5.18.0</p>
<p>Last modified by: 
            <i class='fas fa-user'></i> Russell Feldhausen
            <i class='fas fa-calendar'></i> <a href="https://gitlab.cs.ksu.edu/cs-textbooks/cis400-textbook/-/commit/681e5c9c43e3ac6de614c2cc74487702fd43cab7">Aug 10, 2023</a>
</p>
</div>

    
    </div>
    <script src="https://ksu-cs-textbooks.github.io/cis400/js/clipboard.min.js?1692653063" defer></script>
    <script src="https://ksu-cs-textbooks.github.io/cis400/js/perfect-scrollbar.min.js?1692653063" defer></script>
    <script src="https://ksu-cs-textbooks.github.io/cis400/js/theme.js?1692653063" defer></script>
  </body>
</html>
